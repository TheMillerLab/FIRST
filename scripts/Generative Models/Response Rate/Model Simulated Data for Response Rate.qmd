---
title: "Model Simulated Data for Response Rate"
format: 
  html:
    echo: false
    message: false
    warning: false
---

# Load Packages
```{r}
library(tidyverse)
library(brms)
source(here::here("scripts/load_packages.R"))
library(rethinking)
```


# Simulated Data
```{r}
# Simulate Data

# Step 1: Set up the basic structure
set.seed(123)
n <- 189

sim_data <- tibble(
  patient_id = 1:n,
  age = rnorm(n, mean = 76, sd = 12),
  sex = sample(c("Male", "Female"), n, replace = TRUE, prob = c(0.76, 0.24))
)


# Step 2: Add immune status 
sim_data <- sim_data |>
  mutate(
    immunosupp_type = sample(
      c("None", "Chronic", "Hematologic", "HIV", "Chronic+Hematologic"),
      n, replace = TRUE,
      prob = c(0.83, 0.06, 0.082, 0.005, 0.022)
    ),
    immunosuppressed = (immunosupp_type != "None")
  )

# Step 3a: Add Location first (before Stage)
# Step 3a: Add Location first (before Stage)
sim_data <- sim_data |>
  mutate(
    location = sample(
      c("Head/Neck", "Conjunctiva", "Genitalia", "Lower Extremity", 
        "Upper Extremity", "Trunk", "Unknown Primary"),
      n, replace = TRUE,
      prob = c(0.86, 0.033, 0.005, 0.016, 0.022, 0.027, 0.033)
    ),
    # Condense location immediately
    location_condensed = case_when(
      location == "Head/Neck" ~ "Head/Neck",
      location == "Conjunctiva" ~ "Conjunctiva",
      location == "Unknown Primary" ~ "Unknown Primary",
      TRUE ~ "Other"
    ),
    # Set Head/Neck as reference
    location_condensed = relevel(factor(location_condensed), ref = "Head/Neck")
  )


# Step 3b: Add Stage (conditional on Location)
sim_data <- sim_data |>
  rowwise() |>
  mutate(
    stage = if_else(
      location == "Conjunctiva",
      sample(c("II", "III", "Unstaged"), 1, prob = c(0.3, 0.5, 0.2)),
      sample(c("I", "II", "III", "IV", "Unstaged"), 1, 
             prob = c(0.005, 0.038, 0.40, 0.45, 0.11))
    )
  ) |>
  ungroup()


# Step 4: Add Agent
sim_data <- sim_data |>
  mutate(
    agent = sample(
      c("Cemiplimab", "Pembrolizumab", "Ipi+Nivo"),
      n, replace = TRUE,
      prob = c(0.70, 0.28, 0.02)
    )
  )

# Step 5: Performance Status (influenced by age, immune status, stage)
sim_data <- sim_data |>
  mutate(
    # Create a latent "frailty" score influenced by predictors
    ps_score = 
      scale(age)[,1] * 0.3 +                    # Older → worse PS
      ifelse(immunosuppressed, 0.5, 0) +        # Immunosuppressed → worse PS
      case_when(
        stage == "I" ~ -0.5,
        stage == "II" ~ -0.3,
        stage == "III" ~ 0,
        stage == "IV" ~ 0.6,
        TRUE ~ 0
      ) + rnorm(n, 0, 0.8),                     # Random variation
    
    # Convert to ECOG categories
    ecog = case_when(
      ps_score < -0.5 ~ 0,
      ps_score < 0.5 ~ 1,
      ps_score < 1.5 ~ 2,
      TRUE ~ 3
    )
  )

# Step 6: Number of doses (adjusted for realistic agent dosing)

# Your observed dose distribution
observed_doses <- c(
  rep(1, 11), rep(2, 79), rep(3, 19), rep(4, 18), rep(5, 11),
  rep(6, 9), rep(7, 6), rep(8, 9), rep(9, 5), rep(10, 1),
  rep(11, 3), rep(13, 2), rep(14, 3), rep(15, 2), rep(16, 3),
  rep(20, 1), rep(28, 1), rep(43, 1)
)

# Step 6: Sample doses from observed distribution, override for Ipi+Nivo
sim_data <- sim_data |>
  mutate(
    num_doses = sample(observed_doses, n, replace = TRUE),
    # Override for Ipi+Nivo patients
    num_doses = ifelse(agent == "Ipi+Nivo", sample(1:2, n, replace = TRUE), num_doses)
  )

sim_data <- sim_data |>
  mutate(dose_minus_1 = num_doses - 1)

alpha <- 0.4
beta_dose <- 0 # NO dose effect
sim_data_null <- sim_data |>
  mutate(
    response_prob = plogis(
      alpha +                                            # Baseline (α)
        beta_dose * dose_minus_1 +                       # NO DOSE EFFECT!
        -0.8 * immunosuppressed +                        # Immunosuppressed: worse
        -2.3 * (location_condensed == "Conjunctiva") +   # Changed from location; Conjunctiva: worse
        -0.01 * (age - 76)                             # Slight age effect
    ),
    response = rbinom(n(), 1, response_prob)
  )
response_rate <- sum(sim_data_null$response)/nrow(sim_data_null) * 100
#response_rate
# plogis() is the inverse logit function (also called the logistic function).
## It converts log-odds → probability:
### Formula: p = exp(x) / (1 + exp(x)) where x is the log-odds
#plogis(0)    # log-odds of 0 → 50% probability
#plogis(1)    # log-odds of 1 → 73% probability
#plogis(-1)   # log-odds of -1 → 27% probability
## opposite is qlogis (takes probability and converts to log-odds)
#qlogis(.50)
# Example of how these calculations affect response rate
baseline <- plogis(alpha)  
#baseline
with_immunosupp <- plogis(alpha + (-0.8))  # 0.3 - 0.8 = -0.5
#with_immunosupp  
drop <- baseline - with_immunosupp  
#drop
with_conjunctiva <- plogis(alpha+(-2.3))
#with_conjunctiva
with_male <- plogis(alpha + 0.2)
#with_male



# condense parameters to increase our EPV
# Apply condensed categories to simulated null dataset
sim_data_null_condensed <- sim_data_null |>
  mutate(
    
    # Condense ECOG
    ecog_condensed = if_else(ecog <= 1, "ECOG 0-1", "ECOG 2-3"),
    
    # Condense stage
    stage_condensed = case_when(
      stage %in% c("I", "II") ~ "Stage I-II",
      stage == "III" ~ "Stage III",
      stage == "IV" ~ "Stage IV",
      stage == "Unstaged" ~ "Unstaged"
    ),
    
    # Add dose_minus_1
    dose_minus_1 = num_doses - 1,
    
    # Center age
    age_centered = age - 76
  )

```

# Define priors
```{r}
#| label: define-priors

library(brms)
# Skeptical: centered at null
priors_linear_skeptical <- c(
  prior(normal(0, 1), class = Intercept),
  prior(normal(0, 0.5), class = b, coef = dose_minus_1),  # Centered at 0
  prior(normal(0, 0.1), class = b, coef = age_centered),
  prior(normal(-0.6, 0.2), class = b, coef = immunosuppressedTRUE),
  prior(normal(0, 0.5), class = b, coef = location_condensedConjunctiva),
  prior(normal(0, 0.3), class = b, coef = location_condensedOther),
  prior(normal(0, 0.3), class = b, coef = location_condensedUnknownPrimary),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIII),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIV),
  prior(normal(0, 0.3), class = b, coef = stage_condensedUnstaged),
  prior(normal(0, 0.3), class = b, coef = agentPembrolizumab),
  prior(normal(0.4, 0.3), class = b, coef = agentIpiPNivo),
  prior(normal(-0.3, 0.3), class = b, coef = ecog_condensedECOG2M3)
)

# Weak: modest positive effect
priors_linear_weak <- c(
  prior(normal(0, 1), class = Intercept),
  prior(normal(0.1, 0.3), class = b, coef = dose_minus_1),  # Modest effect
  prior(normal(0, 0.1), class = b, coef = age_centered),
  prior(normal(-0.6, 0.2), class = b, coef = immunosuppressedTRUE),
  prior(normal(-1.0, 0.5), class = b, coef = location_condensedConjunctiva),
  prior(normal(0, 0.3), class = b, coef = location_condensedOther),
  prior(normal(0, 0.3), class = b, coef = location_condensedUnknownPrimary),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIII),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIV),
  prior(normal(0, 0.3), class = b, coef = stage_condensedUnstaged),
  prior(normal(0, 0.3), class = b, coef = agentPembrolizumab),
  prior(normal(0.4, 0.3), class = b, coef = agentIpiPNivo),
  prior(normal(-0.3, 0.3), class = b, coef = ecog_condensedECOG2M3)
)

priors_linear_informative  <- c(
  # Intercept: baseline response probability
  # normal(0, 1) on logit scale → plogis(0) ≈ 50% baseline response
  # SD = 0.7 allows wide range (20%-90%)
  prior(normal(0, 1), class = Intercept),
  
  # Dose effect: modest positive effect expected
  # normal(0.15, 0.2) → OR ≈ 1.15 per dose, SD allows OR 0.7-1.5
  prior(normal(0.15, 0.2), class = b, coef = dose_minus_1),
  
  # Age: minimal effect expected (per year from mean age 76)
  # normal(0, 0.01) → essentially flat, allows small age effects
  prior(normal(0, 0.1), class = b, coef = age_centered),
  
  # Immunosuppression: moderate negative effect expected
  # normal(-0.6, 0.2) → OR ≈ 0.55, based on literature showing worse outcomes
  prior(normal(-0.6, 0.2), class = b, coef = immunosuppressedTRUE),
  
  # Location effects: weakly informative, centered at 0 (no strong prior belief)
  # normal(0, 0.3) → OR range 0.4-2.5
  prior(normal(-2.3, 0.5), class = b, coef = location_condensedConjunctiva),
  prior(normal(0, 0.3), class = b, coef = location_condensedOther),
  prior(normal(0, 0.3), class = b, coef = location_condensedUnknownPrimary),

  # Stage effects: weakly informative
  # normal(0, 0.3) allows for stage differences without strong assumptions
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIII),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIV),
  prior(normal(0, 0.3), class = b, coef = stage_condensedUnstaged),
  
  # Agent effects: 
  # Pembrolizumab: normal(0, 0.3) → similar to cemiplimab (reference)
  prior(normal(0, 0.3), class = b, coef = agentPembrolizumab),
  
  # Ipi+Nivo: normal(0.4, 0.3) → slightly optimistic based on dual checkpoint
  prior(normal(0.4, 0.3), class = b, coef = agentIpiPNivo),
  
  # ECOG performance status: worse PS → lower response
  # normal(-0.3, 0.3) → OR ≈ 0.74 for ECOG 2-3 vs 0-1
  prior(normal(-0.3, 0.3), class = b, coef = ecog_condensedECOG2M3)
)
# Skeptical: centered at null
priors_log_skeptical <- c(
  prior(normal(0, 1), class = Intercept),
  prior(normal(0, 0.7), class = b, coef = log_dose),  # Centered at 0, wider
  prior(normal(0, 0.1), class = b, coef = age_centered),
  prior(normal(-0.6, 0.2), class = b, coef = immunosuppressedTRUE),
  prior(normal(0, 0.5), class = b, coef = location_condensedConjunctiva), 
  prior(normal(0, 0.3), class = b, coef = location_condensedOther),
  prior(normal(0, 0.3), class = b, coef = location_condensedUnknownPrimary),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIII),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIV),
  prior(normal(0, 0.3), class = b, coef = stage_condensedUnstaged),
  prior(normal(0, 0.3), class = b, coef = agentPembrolizumab),
  prior(normal(0.4, 0.3), class = b, coef = agentIpiPNivo),
  prior(normal(-0.3, 0.3), class = b, coef = ecog_condensedECOG2M3)
)

# Weak: modest positive effect
priors_log_weak <- c(
  prior(normal(0, 1), class = Intercept),
  prior(normal(0.15, 0.4), class = b, coef = log_dose),
  prior(normal(0, 0.1), class = b, coef = age_centered),
  prior(normal(-0.6, 0.2), class = b, coef = immunosuppressedTRUE),
  prior(normal(-1.0, 0.5), class = b, coef = location_condensedConjunctiva),
  prior(normal(0, 0.3), class = b, coef = location_condensedOther),
  prior(normal(0, 0.3), class = b, coef = location_condensedUnknownPrimary),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIII),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIV),
  prior(normal(0, 0.3), class = b, coef = stage_condensedUnstaged),
  prior(normal(0, 0.3), class = b, coef = agentPembrolizumab),
  prior(normal(0.4, 0.3), class = b, coef = agentIpiPNivo),
  prior(normal(-0.3, 0.3), class = b, coef = ecog_condensedECOG2M3)
)


# Informative prior (strong effect expected)
priors_log_informative <- c(
  prior(normal(0, 1), class = Intercept),
  prior(normal(0.25, 0.3), class = b, coef = log_dose),
  prior(normal(0, 0.1), class = b, coef = age_centered),
  prior(normal(-0.6, 0.2), class = b, coef = immunosuppressedTRUE),
  prior(normal(-2.3, 0.5), class = b, coef = location_condensedConjunctiva),  
  prior(normal(0, 0.3), class = b, coef = location_condensedOther),
  prior(normal(0, 0.3), class = b, coef = location_condensedUnknownPrimary),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIII),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIV),
  prior(normal(0, 0.3), class = b, coef = stage_condensedUnstaged),
  prior(normal(0, 0.3), class = b, coef = agentPembrolizumab),
  prior(normal(0.4, 0.3), class = b, coef = agentIpiPNivo),
  prior(normal(-0.3, 0.3), class = b, coef = ecog_condensedECOG2M3)
)



```

# Fit the model

## Null Beta, Informative Prior
```{r}
#| label: fit-the-null_informative_linear_model
fit_null_informative <- brm(
  response ~ dose_minus_1 + age_centered + immunosuppressed + 
             location_condensed + stage_condensed + agent + ecog_condensed,
  data = sim_data_null_condensed,
  family = bernoulli(link = "logit"),
  prior = priors_linear_informative,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 123
)

save_files(
  save_object = fit_null_informative,
  filename = "Generative Model No Dose-Response Relationship with Informative Prior.rds",
  subD = "files/Generative Models/null_informative"
)

```

```{r}
# 1. Look at the summary
summary(fit_null_informative)

# 2. Check specifically for β_dose (our key parameter)
fixef(fit_null_informative)["dose_minus_1", ]

```





```{r}
#| label: sample-posterior
library(bayesplot)
library(tidybayes)

# Extract posterior draws for dose effect
posterior_dose <- as_draws_df(fit_null_informative) |>
  select(b_dose_minus_1)
```



```{r}
head(posterior_dose)
```


```{r}
#| label: fig-visualize-posterior-linear-model-null-effect
#| fig-cap: >
#|   **Null Effect Validation: Linear Dose Model.**
#|   Posterior distribution for dose effect (β_dose) fitted to simulated data 
#|   with no true dose-response relationship (true β = 0). The model correctly 
#|   centers near zero with 89% credible interval spanning the null, 
#|   demonstrating appropriate uncertainty quantification when no effect exists.

posterior_null <- as_draws_df(fit_null_informative) |>
  pull(b_dose_minus_1)

baseline_logodds_null <- fixef(fit_null_informative)["Intercept", "Estimate"]
baseline_rr_null <- plogis(baseline_logodds_null)

# Calculate effect sizes
rr_beta_05_null <- plogis(baseline_logodds_null + 0.05) - baseline_rr_null
rr_beta_10_null <- plogis(baseline_logodds_null + 0.10) - baseline_rr_null

dens_null <- density(posterior_null)
dens_df_null <- data.frame(x = dens_null$x, y = dens_null$y)

ci_lower_null <- quantile(posterior_null, 0.055)
ci_upper_null <- quantile(posterior_null, 0.945)

plot_null_linear_informative <- 
  ggplot() +
  geom_line(data = dens_df_null, aes(x = x, y = y), linewidth = 1, color = "steelblue") +
  geom_area(data = subset(dens_df_null, x > 0 & x < 0.05),
            aes(x = x, y = y), fill = "darkgreen", alpha = 0.3) +
  geom_area(data = subset(dens_df_null, x >= 0.05 & x < 0.10),
            aes(x = x, y = y), fill = "#2E7C71", alpha = 0.3) +
  geom_area(data = subset(dens_df_null, x >= 0.10),
            aes(x = x, y = y), fill = "purple", alpha = 0.3) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
  geom_vline(xintercept = c(ci_lower_null, ci_upper_null), linetype = "dotted", color = "darkblue") +
  annotate("text", x = 0, y = max(dens_df_null$y) * 0.95, 
           label = "True β = 0", hjust = -0.2, color = "red", size = 3.5) +
  annotate("text", x = mean(posterior_null), 
           y = max(dens_df_null$y) * 0.6,
           label = paste0("89% CrI: [", round(ci_lower_null, 2), ", ", round(ci_upper_null, 2), "]"),
           size = 3.4) +
  annotate("text", 
           x = 0.08, y = max(dens_df_null$y) * 0.85,
           label = paste0("P(β > 0) = ", round(mean(posterior_null > 0) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "darkgreen") +
  annotate("text", 
           x = 0.08, y = max(dens_df_null$y) * 0.75,
           label = paste0("P(β > 0.05) = ", round(mean(posterior_null > 0.05) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "#2E7C71") +
  annotate("text", 
           x = 0.08, y = max(dens_df_null$y) * 0.65,
           label = paste0("P(β > 0.10) = ", round(mean(posterior_null > 0.10) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "purple") +
  labs(
    title = "Null Effect Validation",
    subtitle = "True β = 0 (no dose-response)",
    x = "β_dose (log-odds per dose)",
    y = "Posterior Density"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "bold")
  )
plot_null_linear_informative

```




# Posterior Predictive Check


```{r}
# Generate predicted datasets from your model
pp_check(fit_null_informative, ndraws = 100)
```

This will:
1. Draw 100 simulated datasets from your posterior
2. Plot them against your actual data
3. Show you if the model captures the patterns

```{r}
# Check overall response rate
actual_response_rate <- mean(sim_data_null_condensed$response)
actual_response_rate

# Simulate response rates from posterior
pp_draws <- posterior_predict(fit_null_informative, draws = 1000)
predicted_rates <- rowMeans(pp_draws)

hist(predicted_rates, main = "Posterior Predictive: Response Rate",
     xlab = "Predicted Response Rate")
abline(v = actual_response_rate, col = "red", lwd = 2)

```

```{r}
# Create dose groups
sim_data_null_condensed$dose_group <- cut(sim_data_null_condensed$num_doses, 
                                           breaks = c(0, 2, 5, 50),
                                           labels = c("1-2", "3-5", "6+"))

# Actual response rate by dose group
actual_by_dose <- sim_data_null_condensed |>
  group_by(dose_group) |>
  summarise(response_rate = mean(response))

actual_by_dose

```

```{r}
# Get predicted probabilities for each patient
pred_probs <- fitted(fit_null_informative)[, "Estimate"]

# Add to data
sim_data_null_condensed$predicted_prob <- pred_probs

# Predicted response rate by dose group
predicted_by_dose <- sim_data_null_condensed |>
  group_by(dose_group) |>
  summarise(predicted_rate = mean(predicted_prob))

predicted_by_dose

```


### Model Null Effect with Skeptical prior
```{r}
#| label: fit-the-null_skeptical_linear_model
fit_null_skeptical <- brm(
  response ~ dose_minus_1 + age_centered + immunosuppressed + 
             location_condensed + stage_condensed + agent + ecog_condensed,
  data = sim_data_null_condensed,
  family = bernoulli(link = "logit"),
  prior = priors_linear_skeptical,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 123
)

save_files(
  save_object = fit_null_skeptical,
  filename = "Generative Model No Dose-Response Relationship with Skeptical Prior.rds",
  subD = "files/Generative Models/null_skeptical"
)

```

```{r}
# 1. Look at the summary
summary(fit_null_skeptical)

# 2. Check specifically for β_dose (our key parameter)
fixef(fit_null_skeptical)["dose_minus_1", ]

```



```{r}
#| label: sample-posterior
library(bayesplot)
library(tidybayes)

# Extract posterior draws for dose effect
posterior_dose <- as_draws_df(fit_null_skeptical) |>
  select(b_dose_minus_1)
```


```{r}
#| label: fig-visualize-posterior-linear-model-null-effect
#| fig-cap: >
#|   **Null Effect Validation: Linear Dose Model.**
#|   Posterior distribution for dose effect (β_dose) fitted to simulated data 
#|   with no true dose-response relationship (true β = 0). The model correctly 
#|   centers near zero with 89% credible interval spanning the null, 
#|   demonstrating appropriate uncertainty quantification when no effect exists.

posterior_null <- as_draws_df(fit_null_skeptical) |>
  pull(b_dose_minus_1)

baseline_logodds_null <- fixef(fit_null_skeptical)["Intercept", "Estimate"]
baseline_rr_null <- plogis(baseline_logodds_null)

# Calculate effect sizes
rr_beta_05_null <- plogis(baseline_logodds_null + 0.05) - baseline_rr_null
rr_beta_10_null <- plogis(baseline_logodds_null + 0.10) - baseline_rr_null

dens_null <- density(posterior_null)
dens_df_null <- data.frame(x = dens_null$x, y = dens_null$y)

ci_lower_null <- quantile(posterior_null, 0.055)
ci_upper_null <- quantile(posterior_null, 0.945)

plot_null_linear_skeptical <- 
  ggplot() +
  geom_line(data = dens_df_null, aes(x = x, y = y), linewidth = 1, color = "steelblue") +
  geom_area(data = subset(dens_df_null, x > 0 & x < 0.05),
            aes(x = x, y = y), fill = "darkgreen", alpha = 0.3) +
  geom_area(data = subset(dens_df_null, x >= 0.05 & x < 0.10),
            aes(x = x, y = y), fill = "#2E7C71", alpha = 0.3) +
  geom_area(data = subset(dens_df_null, x >= 0.10),
            aes(x = x, y = y), fill = "purple", alpha = 0.3) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
  geom_vline(xintercept = c(ci_lower_null, ci_upper_null), linetype = "dotted", color = "darkblue") +
  annotate("text", x = 0, y = max(dens_df_null$y) * 0.95, 
           label = "True β = 0", hjust = -0.2, color = "red", size = 3.5) +
  annotate("text", x = mean(posterior_null), 
           y = max(dens_df_null$y) * 0.6,
           label = paste0("89% CrI: [", round(ci_lower_null, 2), ", ", round(ci_upper_null, 2), "]"),
           size = 3.4) +
  annotate("text", 
           x = 0.062, y = max(dens_df_null$y) * 0.85,
           label = paste0("P(β > 0) = ", round(mean(posterior_null > 0) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "darkgreen") +
  annotate("text", 
           x = 0.062, y = max(dens_df_null$y) * 0.75,
           label = paste0("P(β > 0.05) = ", round(mean(posterior_null > 0.05) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "#2E7C71") +
  annotate("text", 
           x = 0.062, y = max(dens_df_null$y) * 0.65,
           label = paste0("P(β > 0.10) = ", round(mean(posterior_null > 0.10) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "purple") +
  labs(
    title = "Null Effect Validation",
    subtitle = "True β = 0 (no dose-response)",
    x = "β_dose (log-odds per dose)",
    y = "Posterior Density"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "bold")
  )
plot_null_linear_skeptical

```



```{r}
sim_data_null_condensed <- sim_data_null |>
  mutate(
    
    # Condense ECOG
    ecog_condensed = if_else(ecog <= 1, "ECOG 0-1", "ECOG 2-3"),
    
    # Condense stage
    stage_condensed = case_when(
      stage %in% c("I", "II") ~ "Stage I-II",
      stage == "III" ~ "Stage III",
      stage == "IV" ~ "Stage IV",
      stage == "Unstaged" ~ "Unstaged"
    ),
    
    # Add dose_minus_1
    dose_minus_1 = num_doses - 1,
    
    # Center age
    age_centered = age - 76
  )

table(sim_data_null_condensed$location_condensed)
table(sim_data_null_condensed$stage_condensed)
table(sim_data_null_condensed$dose_minus_1)


# Simulate data with MODERATE dose effect (β_dose = 0.2)
alpha <- 0.4
beta_dose <- 0.2 # DOSE EFFECT! (β = 0.2); odds ratio  per additional dose=e^0.2 ≈ 1.22 or 22% above baseline (here baseline is 40%)
sim_data_effect <- sim_data |>
  mutate(
    response_prob = plogis(
      alpha +                                    # Baseline (α)
        beta_dose * dose_minus_1 +               # DOSE EFFECT! (β = 0.2) == OR of 1.22
        -0.8 * immunosuppressed +                # Immunosuppressed: worse
        -2.3 * (location_condensed == "Conjunctiva") +     # Conjunctiva: worse
        -0.01 * (age - 76) +                     # Slight age effect
        rnorm(n(), 0, 0.3)                       # Random variation
    ),
    response = rbinom(n(), 1, response_prob)
  ) |>
  # Apply condensed categories
  mutate(
    ecog_condensed = if_else(ecog <= 1, "ECOG 0-1", "ECOG 2-3"),
    stage_condensed = case_when(
      stage %in% c("I", "II") ~ "Stage I-II",
      stage == "III" ~ "Stage III",
      stage == "IV" ~ "Stage IV",
      stage == "Unstaged" ~ "Unstaged"
    ),
    dose_minus_1 = num_doses - 1,
    age_centered = age - 76
  )

mean(sim_data_effect$response)

# Response rate by dose group
sim_data_effect$dose_group <- cut(sim_data_effect$num_doses, 
                                  breaks = c(0, 2, 5, 50),
                                  labels = c("1-2", "3-5", "6+"))

sim_data_effect |>
  group_by(dose_group) |>
  summarise(response_rate = mean(response))

```

```{r}
# Fit model to effect dataset (same priors)
fit_effect_informative <- brm(
  response ~ dose_minus_1 + age_centered + immunosuppressed + 
             location_condensed + stage_condensed + agent + ecog_condensed,
  data = sim_data_effect,
  family = bernoulli(link = "logit"),
  prior = priors_linear_informative,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 456
)

save_files(
  save_object = fit_effect_informative,
  filename = "Generative Model with known linear dose-response relationship with informative prior.rds",
  subD = "files/Generative Models/linear_dose_response_informative"
)


```

```{r}
# 1. Look at the summary
summary(fit_effect_informative)

# 2. Check specifically for β_dose (our key parameter)
fixef(fit_effect_informative)["dose_minus_1", ]

```




```{r}
# Get predicted probabilities
pred_probs_effect <- fitted(fit_effect_informative)[, "Estimate"]
sim_data_effect$predicted_prob <- pred_probs_effect

# Compare actual vs predicted by dose group
comparison <- sim_data_effect |>
  group_by(dose_group) |>
  summarise(
    actual = mean(response),
    predicted = mean(predicted_prob)
  )

comparison

# Plot it
barplot(
  height = rbind(comparison$actual, comparison$predicted),
  beside = TRUE,
  names.arg = comparison$dose_group,
  col = c("steelblue", "coral"),
  legend = c("Actual", "Predicted"),
  main = "Dose-Response: Actual vs Model Predictions",
  xlab = "Dose Group",
  ylab = "Response Rate",
  ylim = c(0, 1)
)

```


```{r}
posterior_effect_informative <- as_draws_df(fit_effect_informative) |>
  pull(b_dose_minus_1)

# Get intercept from model
baseline_logodds <- fixef(fit_effect_informative)["Intercept", "Estimate"]
baseline_rr <- plogis(baseline_logodds)

# Response rates at different betas
rr_beta_05 <- plogis(baseline_logodds + 0.05) - baseline_rr
rr_beta_10 <- plogis(baseline_logodds + 0.10) - baseline_rr
rr_beta_20 <- plogis(baseline_logodds + 0.20) - baseline_rr

# Create density object
dens <- density(posterior_effect_informative)
dens_df <- data.frame(x = dens$x, y = dens$y)
ymax <- max(dens_df$y)

# Calculate 89% credible intervals
ci_lower <- quantile(posterior_effect_informative, 0.055)
ci_upper <- quantile(posterior_effect_informative, 0.945)
prob_positive <- mean(posterior_effect_informative > 0)



plot_effect_informative <- 
  ggplot() +

  # outline only
  geom_line(data = dens_df, aes(x = x, y = y), linewidth = 1, color = "steelblue") +

  # shaded regions (same density object)
  geom_area(data = subset(dens_df, x > 0 & x < 0.05),
            aes(x = x, y = y), fill = "darkgreen", alpha = 0.3) +
  geom_area(data = subset(dens_df, x >= 0.05 & x < 0.10),
            aes(x = x, y = y), fill = "#2E7C71", alpha = 0.3) +
  geom_area(data = subset(dens_df, x >= 0.10 & x < 0.20),
            aes(x = x, y = y), fill = "purple", alpha = 0.3) +
  geom_area(data = subset(dens_df, x >= 0.20),
            aes(x = x, y = y), fill = "orange", alpha = 0.35) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
  geom_vline(xintercept = c(ci_lower, ci_upper), linetype = "dotted", color = "darkblue") +
  annotate("text", x = 0, y = max(density(posterior_effect_informative)$y) * 0.95, 
           label = "Null", hjust = -0.2, color = "red") +
  annotate("text", x = mean(posterior_effect_informative), 
           y = max(density(posterior_effect_informative)$y) * 0.6,
           label = paste0("89% CrI: [", round(ci_lower, 2), ", ", round(ci_upper, 2), "]"),
           size = 3.4) +
  annotate("text", 
           x = 0.3, y = max(density(posterior_effect_informative)$y) * 0.95,
           label = paste0("P(β > 0 | ↑ dose → ↑ ORR) = ", round(prob_positive * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "darkgreen") +
  annotate(
    "text", 
    x = 0.3, 
    y = max(density(posterior_effect_informative)$y) * 0.85,
    label = paste0(
      "P(β > 0.05 | ≈ ↑", 
      round(rr_beta_05 * 100, 1),
      "% per dose) = ",
      round(mean(posterior_effect_informative > 0.05) * 100, 1), 
      "%"),
    size = 3.4, hjust = 0, color = "#2E7C71") +
  annotate(
    "text", 
    x = 0.3, 
    y = max(density(posterior_effect_informative)$y) * 0.75,
         
    label = paste0(
      "P(β > 0.10 | ≈ ↑", 
      round(rr_beta_10 * 100, 1), 
      "% per dose) = ", 
      round(mean(posterior_effect_informative > 0.10) * 100, 1), 
      "%"),
    size = 3.4, hjust = 0, color = "purple"
    ) +
  annotate(
    "text", 
    x = 0.3, 
    y = max(density(posterior_effect_informative)$y) * 0.65,
    label = paste0(
      "P(β > 0.20 | ≈ ↑", 
      round(rr_beta_20 * 100, 1), 
      "% per dose) = ", 
      round(mean(posterior_effect_informative > 0.20) * 100, 1), 
      "%"),
    size = 3.4, hjust = 0, color = "orange"
    ) +
  labs(
    title = "Posterior Distribution: Linear Dose Effect",
    subtitle = "informative Prior",
    x = "β_dose (log-odds per dose)",
    y = "Density"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "bold")
  )

plot_effect_informative
```
```{r}
#| label: fig-visualize-posterior-linear-model-moderate-effect
#| fig-cap: >
#|   **Moderate Linear Effect Validation.**
#|   Posterior distribution for dose effect fitted to simulated data with 
#|   true β = 0.2. Model successfully recovers the moderate effect with 
#|   posterior centered near true value, demonstrating sensitivity to 
#|   detect clinically meaningful dose-response relationships.

posterior_moderate <- as_draws_df(fit_effect_informative) |>
  pull(b_dose_minus_1)

baseline_logodds_mod <- fixef(fit_effect_informative)["Intercept", "Estimate"]
baseline_rr_mod <- plogis(baseline_logodds_mod)

rr_beta_05_mod <- plogis(baseline_logodds_mod + 0.05) - baseline_rr_mod
rr_beta_10_mod <- plogis(baseline_logodds_mod + 0.10) - baseline_rr_mod
rr_beta_20_mod <- plogis(baseline_logodds_mod + 0.20) - baseline_rr_mod

dens_mod <- density(posterior_moderate)
dens_df_mod <- data.frame(x = dens_mod$x, y = dens_mod$y)

ci_lower_mod <- quantile(posterior_moderate, 0.055)
ci_upper_mod <- quantile(posterior_moderate, 0.945)

plot_moderate_linear_informative <- 
  ggplot() +
  geom_line(data = dens_df_mod, aes(x = x, y = y), linewidth = 1, color = "steelblue") +
  geom_area(data = subset(dens_df_mod, x > 0 & x < 0.05),
            aes(x = x, y = y), fill = "darkgreen", alpha = 0.3) +
  geom_area(data = subset(dens_df_mod, x >= 0.05 & x < 0.10),
            aes(x = x, y = y), fill = "#2E7C71", alpha = 0.3) +
  geom_area(data = subset(dens_df_mod, x >= 0.10 & x < 0.20),
            aes(x = x, y = y), fill = "purple", alpha = 0.3) +
  geom_area(data = subset(dens_df_mod, x >= 0.20),
            aes(x = x, y = y), fill = "orange", alpha = 0.35) +
  geom_vline(xintercept = 0.2, linetype = "dashed", color = "red", linewidth = 1) +
  geom_vline(xintercept = c(ci_lower_mod, ci_upper_mod), linetype = "dotted", color = "darkblue") +
  annotate("text", x = 0.2, y = max(dens_df_mod$y) * 0.95, 
           label = "True β = 0.2", hjust = -0.1, color = "red", size = 3.5) +
  annotate("text", x = mean(posterior_moderate), 
           y = max(dens_df_mod$y) * 0.55,
           label = paste0("89% CrI: [", round(ci_lower_mod, 2), ", ", round(ci_upper_mod, 2), "]"),
           size = 3.4) +
  annotate("text", 
           x = 0.308, y = max(dens_df_mod$y) * 0.85,
           label = paste0("P(β > 0) = ", round(mean(posterior_moderate > 0) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "darkgreen") +
  annotate("text", 
           x = 0.308, y = max(dens_df_mod$y) * 0.75,
           label = paste0("P(β > 0.05) = ", round(mean(posterior_moderate > 0.05) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "#2E7C71") +
  annotate("text", 
           x = 0.308, y = max(dens_df_mod$y) * 0.65,
           label = paste0("P(β > 0.10) = ", round(mean(posterior_moderate > 0.10) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "purple") +
  labs(
    title = "Moderate Linear Effect Validation",
    subtitle = "True β = 0.2",
    x = "β_dose (log-odds per dose)",
    y = "Posterior Density"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "bold")
  )

plot_moderate_linear_informative

```


Model linear dose-response relationship with beta == 0.2 with skeptical prior

```{r}
# Fit model to effect dataset (same priors)
fit_effect_skeptical <- brm(
  response ~ dose_minus_1 + age_centered + immunosuppressed + 
             location_condensed + stage_condensed + agent + ecog_condensed,
  data = sim_data_effect,
  family = bernoulli(link = "logit"),
  prior = priors_linear_skeptical,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 124
)

save_files(
  save_object = fit_effect_skeptical,
  filename = "Generative Model with known linear dose-response relationship with skeptical prior.rds",
  subD = "files/Generative Models/linear_dose_response_skeptical"
)
```
```{r}
summary(fit_effect_skeptical)
```

```{r}
posterior_effect_skeptical <- as_draws_df(fit_effect_skeptical) |>
  pull(b_dose_minus_1)

# Get intercept from model
baseline_logodds <- fixef(fit_effect_skeptical)["Intercept", "Estimate"]
baseline_rr <- plogis(baseline_logodds)

# Response rates at different betas
rr_beta_05 <- plogis(baseline_logodds + 0.05) - baseline_rr
rr_beta_10 <- plogis(baseline_logodds + 0.10) - baseline_rr
rr_beta_20 <- plogis(baseline_logodds + 0.20) - baseline_rr

# Create density object
dens <- density(posterior_effect_skeptical)
dens_df <- data.frame(x = dens$x, y = dens$y)
ymax <- max(dens_df$y)

# Calculate 89% credible intervals
ci_lower <- quantile(posterior_effect_skeptical, 0.055)
ci_upper <- quantile(posterior_effect_skeptical, 0.945)
prob_positive <- mean(posterior_effect_skeptical > 0)



plot_effect_skeptical <- 
  ggplot() +

  # outline only
  geom_line(data = dens_df, aes(x = x, y = y), linewidth = 1, color = "steelblue") +

  # shaded regions (same density object)
  geom_area(data = subset(dens_df, x > 0 & x < 0.05),
            aes(x = x, y = y), fill = "darkgreen", alpha = 0.3) +
  geom_area(data = subset(dens_df, x >= 0.05 & x < 0.10),
            aes(x = x, y = y), fill = "#2E7C71", alpha = 0.3) +
  geom_area(data = subset(dens_df, x >= 0.10 & x < 0.20),
            aes(x = x, y = y), fill = "purple", alpha = 0.3) +
  geom_area(data = subset(dens_df, x >= 0.20),
            aes(x = x, y = y), fill = "orange", alpha = 0.35) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
  geom_vline(xintercept = c(ci_lower, ci_upper), linetype = "dotted", color = "darkblue") +
  annotate("text", x = 0, y = max(density(posterior_effect_skeptical)$y) * 0.95, 
           label = "Null", hjust = -0.2, color = "red") +
  annotate("text", x = mean(posterior_effect_skeptical), 
           y = max(density(posterior_effect_skeptical)$y) * 0.6,
           label = paste0("89% CrI: [", round(ci_lower, 2), ", ", round(ci_upper, 2), "]"),
           size = 3.4) +
  annotate("text", 
           x = 0.4, y = max(density(posterior_effect_skeptical)$y) * 0.95,
           label = paste0("P(β > 0 | ↑ dose → ↑ ORR) = ", round(prob_positive * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "darkgreen") +
  annotate(
    "text", 
    x = 0.4, 
    y = max(density(posterior_effect_skeptical)$y) * 0.85,
    label = paste0(
      "P(β > 0.05 | ≈ ↑", 
      round(rr_beta_05 * 100, 1),
      "% per dose) = ",
      round(mean(posterior_effect_skeptical > 0.05) * 100, 1), 
      "%"),
    size = 3.4, hjust = 0, color = "#2E7C71") +
  annotate(
    "text", 
    x = 0.4, 
    y = max(density(posterior_effect_skeptical)$y) * 0.75,
         
    label = paste0(
      "P(β > 0.10 | ≈ ↑", 
      round(rr_beta_10 * 100, 1), 
      "% per dose) = ", 
      round(mean(posterior_effect_skeptical > 0.10) * 100, 1), 
      "%"),
    size = 3.4, hjust = 0, color = "purple"
    ) +
  annotate(
    "text", 
    x = 0.4, 
    y = max(density(posterior_effect_skeptical)$y) * 0.65,
    label = paste0(
      "P(β > 0.20 | ≈ ↑", 
      round(rr_beta_20 * 100, 1), 
      "% per dose) = ", 
      round(mean(posterior_effect_skeptical > 0.20) * 100, 1), 
      "%"),
    size = 3.4, hjust = 0, color = "orange"
    ) +
  labs(
    title = "Posterior Distribution: Linear Dose Effect",
    subtitle = "Skeptical Prior",
    x = "β_dose (log-odds per dose)",
    y = "Density"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "bold")
  )

plot_effect_skeptical
```


# Model Sigmoid Data

```{r}
# Simulate data with SIGMOID pattern (log transformation)
sim_data_sigmoid <- sim_data |>
  mutate(
    # Use log(dose) to create diminishing returns without drop-off
    dose_effect = 0.8 * log(num_doses),
    
    response_prob = plogis(
      -0.4 +                                    # Baseline ((e^-0.4)/(1+e^-0.4)) = 40% response rate
        dose_effect +                            # LOG DOSE EFFECT!
        -0.8 * immunosuppressed +
        -0.6 * (location_condensed == "Conjunctiva") +
        -0.01 * (age - 76) +
        rnorm(n(), 0, 0.3)
    ),
    response = rbinom(n(), 1, response_prob)
  )


sim_data_sigmoid <- sim_data_sigmoid |>
  mutate(
    ecog_condensed = if_else(ecog <= 1, "ECOG 0-1", "ECOG 2-3"),
    stage_condensed = case_when(
      stage %in% c("I", "II") ~ "Stage I-II",
      stage == "III" ~ "Stage III",
      stage == "IV" ~ "Stage IV",
      stage == "Unstaged" ~ "Unstaged"
    ),
    age_centered = age - 76,
    dose_minus_1 = num_doses - 1
  )

sim_data_sigmoid$response
mean(sim_data_sigmoid$response)
```

```{r}
# Fit linear model to sigmoid data
fit_sigmoid_linear <- brm(
  response ~ dose_minus_1 + age_centered + immunosuppressed + 
             location_condensed + stage_condensed + agent + ecog_condensed,
  data = sim_data_sigmoid,
  family = bernoulli(link = "logit"),
  prior = priors_linear_skeptical,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 789
)

```

```{r}
# 1. Look at the summary
summary(fit_sigmoid_linear)

# 2. Check specifically for β_dose (our key parameter)
fixef(fit_sigmoid_linear)["dose_minus_1", ]

```

# Fit Log dose
```{r}
# Add log(dose) to data
sim_data_sigmoid$log_dose <- log(sim_data_sigmoid$num_doses)

# Fit log model
fit_sigmoid_log <- brm(
  response ~ log_dose + age_centered + immunosuppressed + 
             location_condensed + stage_condensed + agent + ecog_condensed,
  data = sim_data_sigmoid,
  family = bernoulli(link = "logit"),
  prior = priors_log_informative,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 890
)

```

```{r}
# 1. Look at the summary
summary(fit_sigmoid_log)

# 2. Check specifically for β_dose (our key parameter)
fixef(fit_sigmoid_log)["log_dose", ]

```



```{r}
#| label: fig-visualize-posterior-log-model-sigmoid-effect
#| fig-cap: >
#|   **Strong Sigmoid Effect Validation.**
#|   Posterior distribution for log-dose effect fitted to simulated data with 
#|   true β_log = 0.8 (diminishing returns pattern). Model successfully recovers 
#|   the nonlinear dose-response relationship, demonstrating ability to detect 
#|   strong effects when present.

posterior_sigmoid <- as_draws_df(fit_sigmoid_log) |>
  pull(b_log_dose)

baseline_logodds_sig <- fixef(fit_sigmoid_log)["Intercept", "Estimate"]

dens_sig <- density(posterior_sigmoid)
dens_df_sig <- data.frame(x = dens_sig$x, y = dens_sig$y)

ci_lower_sig <- quantile(posterior_sigmoid, 0.055)
ci_upper_sig <- quantile(posterior_sigmoid, 0.945)

plot_sigmoid_log_informative <- 
  ggplot() +
  geom_line(data = dens_df_sig, aes(x = x, y = y), linewidth = 1, color = "steelblue") +
  geom_area(data = subset(dens_df_sig, x > 0 & x < 0.5),
            aes(x = x, y = y), fill = "darkgreen", alpha = 0.3) +
  geom_area(data = subset(dens_df_sig, x >= 0.5 & x < 0.8),
            aes(x = x, y = y), fill = "#2E7C71", alpha = 0.3) +
  geom_area(data = subset(dens_df_sig, x >= 0.8),
            aes(x = x, y = y), fill = "purple", alpha = 0.3) +
  geom_vline(xintercept = 0.8, linetype = "dashed", color = "red", linewidth = 1) +
  geom_vline(xintercept = c(ci_lower_sig, ci_upper_sig), linetype = "dotted", color = "darkblue") +
  annotate("text", x = 0.8, y = max(dens_df_sig$y) * 0.95, 
           label = "True β = 0.8", hjust = -0.1, color = "red", size = 3.5) +
  annotate("text", x = mean(posterior_sigmoid), 
           y = max(dens_df_sig$y) * 0.55,
           label = paste0("89% CrI: [", round(ci_lower_sig, 2), ", ", round(ci_upper_sig, 2), "]"),
           size = 3.4) +
  annotate("text", 
           x = 1.15, y = max(dens_df_sig$y) * 0.85,
           label = paste0("P(β > 0) = ", round(mean(posterior_sigmoid > 0) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "darkgreen") +
  annotate("text", 
           x = 1.15, y = max(dens_df_sig$y) * 0.75,
           label = paste0("P(β > 0.5) = ", round(mean(posterior_sigmoid > 0.5) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "#2E7C71") +
  annotate("text", 
           x = 1.15, y = max(dens_df_sig$y) * 0.65,
           label = paste0("P(β > 0.8) = ", round(mean(posterior_sigmoid > 0.8) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "purple") +
  labs(
    title = "Strong Sigmoid Effect Validation",
    subtitle = "True β_log = 0.8 (diminishing returns)",
    x = "β_log_dose",
    y = "Posterior Density"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "bold")
  )

plot_sigmoid_log_informative

```

```{r}
#| label: log-dosing predictions
#| fig.height: 10
# Get predictions from both models
pred_linear <- fitted(fit_sigmoid_linear)[, "Estimate"]
pred_log <- fitted(fit_sigmoid_log)[, "Estimate"]

# Create dose groups
sim_data_sigmoid$dose_group <- cut(sim_data_sigmoid$num_doses, 
                                    breaks = c(0, 1, 2, 4, 50),
                                    labels = c("1", "2", "3-4", "5+"))

# Add to data
sim_data_sigmoid$pred_linear <- pred_linear
sim_data_sigmoid$pred_log <- pred_log

# Compare by dose group
comparison <- sim_data_sigmoid |>
  group_by(dose_group) |>
  summarise(
    actual = mean(response),
    linear_model = mean(pred_linear),
    log_model = mean(pred_log)
  )

comparison

# Plot
barplot(
  height = rbind(comparison$actual, comparison$linear_model, comparison$log_model),
  beside = TRUE,
  names.arg = comparison$dose_group,
  col = c("steelblue", "coral", "green3"),
  legend = c("Actual", "Linear Model", "Log Model"),
  main = "Model Comparison: Linear vs Log(Dose)",
  xlab = "Dose Group",
  ylab = "Response Rate",
  ylim = c(0, 1)
)

```




```{r}
# Create data for smooth curve
dose_seq <- seq(1, 40, by = 0.1)
beta_0 <- -0.4  # Baseline (40% at dose 1)
beta_1 <- 0.25  # Log dose effect from your model

response_curve <- data.frame(
  dose = dose_seq,
  log_odds = beta_0 + beta_1 * log(dose_seq),
  probability = plogis(beta_0 + beta_1 * log(dose_seq))
)

ggplot(response_curve, aes(x = dose, y = probability)) +
  geom_line(color = "steelblue", linewidth = 1.5) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1), breaks = seq(0,1, 0.1)) +
  scale_x_continuous(limits = c(1,40), breaks = seq(1,40,2)) +
  labs(
    title = "Diminishing Returns: Log(Dose) Model",
    x = "Number of Doses",
    y = "Response Probability"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5))

```





```{r}
# Calculate Bayes factor using hypothesis()
hypothesis(fit_sigmoid_log, "log_dose = 0")

```

```{r}
hypothesis(fit_sigmoid_log, "log_dose > 0")

```



```{r}
# Add log(dose) to null data
sim_data_null_condensed$log_dose <- log(sim_data_null_condensed$num_doses)

# Fit log model to null data (where true effect is zero)
fit_null_log <- brm(
  response ~ log_dose + age_centered + immunosuppressed + 
             location_condensed + stage_condensed + agent + ecog_condensed,
  data = sim_data_null_condensed,
  family = bernoulli(link = "logit"),
  prior = priors_log_informative,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 999
)
```


```{r}
# 1. Look at the summary
summary(fit_null_log)

# 2. Check specifically for β_dose (our key parameter)
fixef(fit_null_log)["log_dose", ]

hypothesis(fit_null_log, "log_dose > 0")

```



---

Evalute the effect of a neutral prior



```{r}
# Define skeptical prior for log_dose (centered at 0 instead of 0.8)

# Fit model
fit_null_log_skeptical <- brm(
  response ~ log_dose + age_centered + immunosuppressed + 
             location_condensed + stage_condensed + agent + ecog_condensed,
  data = sim_data_null_condensed,
  family = bernoulli(link = "logit"),
  prior = priors_log_skeptical,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 1000
)

```

```{r}
fixef(fit_null_log)["log_dose", ]           # Original prior (0.8)
fixef(fit_null_log_skeptical)["log_dose", ] # Skeptical prior (0)

```




## Model Sigmoid Data using Moderate Effect (Beta = 0.4)
```{r}
# Simulate data with MODERATE SIGMOID pattern (log transformation)
sim_data_sigmoid_moderate <- sim_data |>
  mutate(
    # Use log(dose) with moderate effect
    dose_effect = 0.4 * log(num_doses),  # Half of strong effect (0.8)
    
    response_prob = plogis(
      -0.4 +                                    # Baseline
        dose_effect +                            # MODERATE LOG DOSE EFFECT
        -0.8 * immunosuppressed +
        -0.6 * (location_condensed == "Conjunctiva") +
        -0.01 * (age - 76) +
        rnorm(n(), 0, 0.3)
    ),
    response = rbinom(n(), 1, response_prob)
  ) |>
  mutate(
    ecog_condensed = if_else(ecog <= 1, "ECOG 0-1", "ECOG 2-3"),
    stage_condensed = case_when(
      stage %in% c("I", "II") ~ "Stage I-II",
      stage == "III" ~ "Stage III",
      stage == "IV" ~ "Stage IV",
      stage == "Unstaged" ~ "Unstaged"
    ),
    age_centered = age - 76,
    log_dose = log(num_doses)
  )
sim_data_sigmoid_moderate$response
mean(sim_data_sigmoid_moderate$response)

```

```{r}
fit_sigmoid_moderate <- brm(
  response ~ log_dose + age_centered + immunosuppressed + 
             location_condensed + stage_condensed + agent + ecog_condensed,
  data = sim_data_sigmoid_moderate,
  family = bernoulli(link = "logit"),
  prior = priors_log_informative,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 891
)

```

```{r}
summary(fit_sigmoid_moderate)
fixef(fit_sigmoid_moderate)["log_dose", ]

```

```{r}
#| label: fig-visualize-posterior-log-model-moderate-sigmoid
#| fig-cap: >
#|   **Moderate Sigmoid Effect Validation.**
#|   Posterior distribution for log-dose effect fitted to simulated data with 
#|   true β_log = 0.4 (moderate diminishing returns). Model successfully recovers 
#|   the moderate nonlinear dose-response relationship.

posterior_sigmoid_mod <- as_draws_df(fit_sigmoid_moderate) |>
  pull(b_log_dose)

dens_sig_mod <- density(posterior_sigmoid_mod)
dens_df_sig_mod <- data.frame(x = dens_sig_mod$x, y = dens_sig_mod$y)

ci_lower_sig_mod <- quantile(posterior_sigmoid_mod, 0.055)
ci_upper_sig_mod <- quantile(posterior_sigmoid_mod, 0.945)

plot_sigmoid_moderate <- 
  ggplot() +
  geom_line(data = dens_df_sig_mod, aes(x = x, y = y), linewidth = 1, color = "steelblue") +
  geom_area(data = subset(dens_df_sig_mod, x > 0 & x < 0.2),
            aes(x = x, y = y), fill = "darkgreen", alpha = 0.3) +
  geom_area(data = subset(dens_df_sig_mod, x >= 0.2 & x < 0.4),
            aes(x = x, y = y), fill = "#2E7C71", alpha = 0.3) +
  geom_area(data = subset(dens_df_sig_mod, x >= 0.4),
            aes(x = x, y = y), fill = "purple", alpha = 0.3) +
  geom_vline(xintercept = 0.4, linetype = "dashed", color = "red", linewidth = 1) +
  geom_vline(xintercept = c(ci_lower_sig_mod, ci_upper_sig_mod), linetype = "dotted", color = "darkblue") +
  annotate("text", x = 0.4, y = max(dens_df_sig_mod$y) * 0.95, 
           label = "True β = 0.4", hjust = -0.1, color = "red", size = 3.5) +
  annotate("text", x = mean(posterior_sigmoid_mod), 
           y = max(dens_df_sig_mod$y) * 0.55,
           label = paste0("89% CrI: [", round(ci_lower_sig_mod, 2), ", ", round(ci_upper_sig_mod, 2), "]"),
           size = 3.4) +
  annotate("text", 
           x = 0.62, y = max(dens_df_sig_mod$y) * 0.85,
           label = paste0("P(β > 0) = ", round(mean(posterior_sigmoid_mod > 0) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "darkgreen") +
  annotate("text", 
           x = 0.62, y = max(dens_df_sig_mod$y) * 0.75,
           label = paste0("P(β > 0.2) = ", round(mean(posterior_sigmoid_mod > 0.2) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "#2E7C71") +
  annotate("text", 
           x = 0.62, y = max(dens_df_sig_mod$y) * 0.65,
           label = paste0("P(β > 0.4) = ", round(mean(posterior_sigmoid_mod > 0.4) * 100, 1), "%"),
           hjust = 0, size = 3.4, color = "purple") +
  labs(
    title = "Moderate Sigmoid Effect Validation",
    subtitle = "True β_log = 0.4",
    x = "β_log_dose",
    y = "Posterior Density"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "bold")
  )

plot_sigmoid_moderate

```

# Categorical Beta for Number of doses



```{r}
# ==============================================================================
# CATEGORICAL MODEL PRIORS (Dose Thresholds)
# ==============================================================================
# Model: response ~ dose_2 + dose_3 + dose_4 + dose_5plus + confounders
# Interpretation: Each β represents ADDITIONAL benefit at that threshold

# ------------------------------------------------------------------------------
# Skeptical: centered at null (no prior belief in dose effect)
# ------------------------------------------------------------------------------
priors_categorical_skeptical <- c(
  # Intercept: baseline at 1 dose
  # normal(0, 1) → plogis(0) = 50% response at 1 dose
  prior(normal(0, 1), class = Intercept),
  
  # Dose thresholds: centered at 0 (skeptical of benefit)
  # normal(0, 0.5) allows OR range 0.4-2.5 for each threshold
  prior(normal(0, 0.5), class = b, coef = dose_2),    # 2nd dose effect
  prior(normal(0, 0.5), class = b, coef = dose_3),    # Additional 3rd dose effect
  prior(normal(0, 0.5), class = b, coef = dose_4),    # Additional 4th dose effect
  prior(normal(0, 0.5), class = b, coef = dose_5plus), # Additional 5+ dose effect
  
  prior(normal(0, 0.1), class = b, coef = age_centered),
  prior(normal(-0.6, 0.2), class = b, coef = immunosuppressedTRUE),
  prior(normal(0, 0.5), class = b, coef = location_condensedConjunctiva), 
  prior(normal(0, 0.3), class = b, coef = location_condensedOther),
  prior(normal(0, 0.3), class = b, coef = location_condensedUnknownPrimary),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIII),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIV),
  prior(normal(0, 0.3), class = b, coef = stage_condensedUnstaged),
  prior(normal(0, 0.3), class = b, coef = agentPembrolizumab),
  prior(normal(0.4, 0.3), class = b, coef = agentIpiPNivo),
  prior(normal(-0.3, 0.3), class = b, coef = ecog_condensedECOG2M3)
)

# ------------------------------------------------------------------------------
# Weak: diminishing returns pattern (modest positive effects)
# ------------------------------------------------------------------------------
priors_categorical_weak <- c(
  # Intercept: baseline at 1 dose = 50%
  prior(normal(0, 1), class = Intercept),
  
  # Dose thresholds: decreasing means (diminishing returns)
  # dose_2: normal(0.3, 0.3) → 1 dose: 50%, 2 doses: plogis(0 + 0.3) = 57%
  prior(normal(0.3, 0.3), class = b, coef = dose_2),
  
  # dose_3: normal(0.2, 0.3) → 3 doses: plogis(0 + 0.3 + 0.2) = 62%
  prior(normal(0.2, 0.3), class = b, coef = dose_3),
  
  # dose_4: normal(0.1, 0.3) → 4 doses: plogis(0 + 0.3 + 0.2 + 0.1) = 65%
  prior(normal(0.1, 0.3), class = b, coef = dose_4),
  
  # dose_5plus: normal(0.05, 0.3) → 5+ doses: plogis(0 + 0.3 + 0.2 + 0.1 + 0.05) = 66%
  prior(normal(0.05, 0.3), class = b, coef = dose_5plus),
  
  # normal(0, 0.01) → essentially flat, OR range 0.98-1.02 per year
  prior(normal(0, 0.1), class = b, coef = age_centered),
  
  # Immunosuppression: moderate negative effect
  # normal(-0.6, 0.2) → OR ≈ 0.55 (immunosuppressed have ~45% lower odds)
  # Based on literature showing worse outcomes in immunosuppressed patients
  prior(normal(-0.6, 0.2), class = b, coef = immunosuppressedTRUE),
  
  # Location effects: weakly informative, centered at 0
  # normal(0, 0.3) → OR range 0.4-2.5 (allows for better or worse by location)
  prior(normal(-1.0, 0.5), class = b, coef = location_condensedConjunctiva),  # UPDATED
  prior(normal(0, 0.3), class = b, coef = location_condensedOther),
  prior(normal(0, 0.3), class = b, coef = location_condensedUnknownPrimary),
  
  # Stage effects: weakly informative
  # normal(0, 0.3) → allows for stage differences without strong assumptions
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIII),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIV),
  prior(normal(0, 0.3), class = b, coef = stage_condensedUnstaged),
  
  # Agent effects
  # Pembrolizumab: normal(0, 0.3) → similar efficacy to cemiplimab (reference)
  prior(normal(0, 0.3), class = b, coef = agentPembrolizumab),
  
  # Ipi+Nivo: normal(0.4, 0.3) → OR ≈ 1.5 (dual checkpoint may be better)
  prior(normal(0.4, 0.3), class = b, coef = agentIpiPNivo),
  
  # ECOG performance status: worse PS → lower response
  # normal(-0.3, 0.3) → OR ≈ 0.74 (ECOG 2-3 have ~26% lower odds vs 0-1)
  prior(normal(-0.3, 0.3), class = b, coef = ecog_condensedECOG2M3)
)

priors_categorical_informative <- c(
  # Intercept: baseline response at 1 dose
  # normal(0, 1) → plogis(0) = 50% response at 1 dose
  # Wide SD allows 12-88% range
  prior(normal(0, 1), class = Intercept),
  
  # dose_2: benefit of 2nd dose (vs 1 dose only)
  # normal(0.4, 0.25) → adds 0.4 to log-odds
  # At 2 doses: plogis(0 + 0.4) = plogis(0.4) = 60% response
  # Tighter SD (0.25) reflects stronger belief in positive effect
  prior(normal(0.4, 0.25), class = b, coef = dose_2),
  
  # dose_3: ADDITIONAL benefit of 3rd dose (beyond 2)
  # normal(0.3, 0.25) → adds another 0.3 to log-odds
  # At 3 doses: plogis(0 + 0.4 + 0.3) = plogis(0.7) = 67% response
  # Diminishing returns: 0.3 < 0.4
  prior(normal(0.3, 0.25), class = b, coef = dose_3),
  
  # dose_4: ADDITIONAL benefit of 4th dose (beyond 3)
  # normal(0.15, 0.25) → adds another 0.15 to log-odds
  # At 4 doses: plogis(0 + 0.4 + 0.3 + 0.15) = plogis(0.85) = 71% response
  # Further diminishing: 0.15 < 0.3 < 0.4
  prior(normal(0.15, 0.25), class = b, coef = dose_4),
  
  # dose_5plus: ADDITIONAL benefit of 5+ doses (beyond 4)
  # normal(0.08, 0.25) → adds another 0.08 to log-odds
  # At 5+ doses: plogis(0 + 0.4 + 0.3 + 0.15 + 0.08) = plogis(0.93) = 72% response
  # Minimal additional benefit: 0.08 < 0.15 < 0.3 < 0.4
  prior(normal(0.08, 0.25), class = b, coef = dose_5plus),
  # normal(0, 0.01) → essentially flat, OR range 0.98-1.02 per year
  prior(normal(0, 0.1), class = b, coef = age_centered),
  
  # Immunosuppression: moderate negative effect
  # normal(-0.6, 0.2) → OR ≈ 0.55 (immunosuppressed have ~45% lower odds)
  # Based on literature showing worse outcomes in immunosuppressed patients
  prior(normal(-0.6, 0.2), class = b, coef = immunosuppressedTRUE),
  
  # Location effects: weakly informative, centered at 0
  # normal(0, 0.3) → OR range 0.4-2.5 (allows for better or worse by location)
  prior(normal(-2.3, 0.5), class = b, coef = location_condensedConjunctiva),  # UPDATED
  prior(normal(0, 0.3), class = b, coef = location_condensedOther),
  prior(normal(0, 0.3), class = b, coef = location_condensedUnknownPrimary),
  
  # Stage effects: weakly informative
  # normal(0, 0.3) → allows for stage differences without strong assumptions
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIII),
  prior(normal(0, 0.3), class = b, coef = stage_condensedStageIV),
  prior(normal(0, 0.3), class = b, coef = stage_condensedUnstaged),
  
  # Agent effects
  # Pembrolizumab: normal(0, 0.3) → similar efficacy to cemiplimab (reference)
  prior(normal(0, 0.3), class = b, coef = agentPembrolizumab),
  
  # Ipi+Nivo: normal(0.4, 0.3) → OR ≈ 1.5 (dual checkpoint may be better)
  prior(normal(0.4, 0.3), class = b, coef = agentIpiPNivo),
  
  # ECOG performance status: worse PS → lower response
  # normal(-0.3, 0.3) → OR ≈ 0.74 (ECOG 2-3 have ~26% lower odds vs 0-1)
  prior(normal(-0.3, 0.3), class = b, coef = ecog_condensedECOG2M3)
)
```


```{r}
#| label: sim_data_cumulative

# Create categorical dose variable
sim_data_cumulative <- sim_data |>
  mutate(
    dose_2 = as.numeric(num_doses >= 2),
    dose_3 = as.numeric(num_doses >= 3),
    dose_4 = as.numeric(num_doses >= 4),
    dose_5plus = as.numeric(num_doses >= 5),
    
    response_prob = plogis(
      0.4 +                                    # Baseline (1 dose)
        0.5 * dose_2 +                         # Big jump: 2nd dose
        0.3 * dose_3 +                         # Moderate: 3rd dose
        0.2 * dose_4 +                         # Small: 4th dose
        0.1 * dose_5plus +                     # Tiny: 5+ doses
        -0.8 * immunosuppressed +
        -0.6 * (location_condensed == "Conjunctiva") +
        -0.01 * (age - 76) +
        rnorm(n(), 0, 0.3)
    ),
    response = rbinom(n(), 1, response_prob)
  ) |>
  mutate(
    ecog_condensed = if_else(ecog <= 1, "ECOG 0-1", "ECOG 2-3"),
    stage_condensed = case_when(
      stage %in% c("I", "II") ~ "Stage I-II",
      stage == "III" ~ "Stage III",
      stage == "IV" ~ "Stage IV",
      stage == "Unstaged" ~ "Unstaged"
    ),
    age_centered = age - 76
  )

sim_data_cumulative |>
  mutate(dose_cat = cut(num_doses, breaks=c(0,1,2,3,4,50), labels=c("1","2","3","4","5+"))) |>
  group_by(dose_cat) |>
  summarise(response_rate = mean(response))


```

```{r}

fit_categorical_skeptical <- brm(
  response ~ dose_2 + dose_3 + dose_4 + dose_5plus + age_centered + 
             immunosuppressed + location_condensed + stage_condensed + 
             agent + ecog_condensed,
  data = sim_data_cumulative,
  family = bernoulli(link = "logit"),
  prior = priors_categorical_skeptical,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 2000
)


```

```{r}
summary(fit_categorical_skeptical)
```


#### Weak Priors

```{r}

fit_categorical_weak <- brm(
  response ~ dose_2 + dose_3 + dose_4 + dose_5plus + age_centered + 
             immunosuppressed + location_condensed + stage_condensed + 
             agent + ecog_condensed,
  data = sim_data_cumulative,
  family = bernoulli(link = "logit"),
  prior = priors_categorical_weak,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 2000
)


```

```{r}
summary(fit_categorical_weak)
```

#### Informative Priors

```{r}

fit_categorical_informative <- brm(
  response ~ dose_2 + dose_3 + dose_4 + dose_5plus + age_centered + 
             immunosuppressed + location_condensed + stage_condensed + 
             agent + ecog_condensed,
  data = sim_data_cumulative,
  family = bernoulli(link = "logit"),
  prior = priors_categorical_informative,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 2000
)


```

```{r}
summary(fit_categorical_informative)
```


```{r}
#| label: fig-visualize-posterior-categorical-model-validation
#| fig-cap: >
#|   **Categorical Threshold Model Validation.**
#|   Posterior distributions for incremental dose threshold effects fitted to 
#|   simulated data with known diminishing returns pattern. Dashed vertical lines 
#|   indicate true simulated values (β₂=0.5, β₃=0.3, β₄=0.2, β₅₊=0.1). Model 
#|   successfully recovers the heterogeneous threshold effects without imposing 
#|   parametric assumptions.

# Extract posteriors
posterior_cat_dose2 <- as_draws_df(fit_categorical_informative) |> pull(b_dose_2)
posterior_cat_dose3 <- as_draws_df(fit_categorical_informative) |> pull(b_dose_3)
posterior_cat_dose4 <- as_draws_df(fit_categorical_informative) |> pull(b_dose_4)
posterior_cat_dose5 <- as_draws_df(fit_categorical_informative) |> pull(b_dose_5plus)

# Combine
posterior_cat_combined <-
  bind_rows(
    tibble(beta = posterior_cat_dose2, threshold = "Dose 2 vs 1", true_beta = 0.5),
    tibble(beta = posterior_cat_dose3, threshold = "Dose 3 vs 2", true_beta = 0.3),
    tibble(beta = posterior_cat_dose4, threshold = "Dose 4 vs 3", true_beta = 0.2),
    tibble(beta = posterior_cat_dose5, threshold = "Dose ≥5 vs 4", true_beta = 0.1)
  ) |>
  mutate(
    threshold = factor(
      threshold,
      levels = c("Dose 2 vs 1", "Dose 3 vs 2", "Dose 4 vs 3", "Dose ≥5 vs 4")
    )
  )

# Colors
cols_cat <- c(
  "Dose 2 vs 1"  = "#1F78B4",
  "Dose 3 vs 2"  = "#1B9E77",
  "Dose 4 vs 3"  = "#D95F02",
  "Dose ≥5 vs 4" = "#7B2CBF"
)

# Summaries
summ_cat <-
  posterior_cat_combined |>
  group_by(threshold) |>
  summarise(
    p_gt0 = mean(beta > 0),
    OR_md = exp(median(beta)),
    true_beta = first(true_beta),
    .groups = "drop"
  )

fmt_pct <- function(x) sprintf("%.1f%%", 100 * x)

ann_text <- paste0(
  "Posterior P(β > 0):\n",
  "Dose 2 vs 1:  ", fmt_pct(summ_cat$p_gt0[summ_cat$threshold=="Dose 2 vs 1"]), "\n",
  "Dose 3 vs 2:  ", fmt_pct(summ_cat$p_gt0[summ_cat$threshold=="Dose 3 vs 2"]), "\n",
  "Dose 4 vs 3:  ", fmt_pct(summ_cat$p_gt0[summ_cat$threshold=="Dose 4 vs 3"]), "\n",
  "Dose ≥5 vs 4: ", fmt_pct(summ_cat$p_gt0[summ_cat$threshold=="Dose ≥5 vs 4"]), "\n\n",
  "Median OR (incremental):\n",
  "Dose 2 vs 1:  ×", sprintf("%.2f", summ_cat$OR_md[summ_cat$threshold=="Dose 2 vs 1"]), "\n",
  "Dose 3 vs 2:  ×", sprintf("%.2f", summ_cat$OR_md[summ_cat$threshold=="Dose 3 vs 2"]), "\n",
  "Dose 4 vs 3:  ×", sprintf("%.2f", summ_cat$OR_md[summ_cat$threshold=="Dose 4 vs 3"]), "\n",
  "Dose ≥5 vs 4: ×", sprintf("%.2f", summ_cat$OR_md[summ_cat$threshold=="Dose ≥5 vs 4"])
)

# Compute ymax
dens_list <- posterior_cat_combined |>
  group_by(threshold) |>
  summarise(dens = list(density(beta, adjust = 1.1)), .groups = "drop")

ymax <- max(vapply(dens_list$dens, function(d) max(d$y), numeric(1)))

plot_categorical_validation <-
  ggplot(posterior_cat_combined, aes(x = beta)) +
  
  geom_density(aes(fill = threshold), alpha = 0.18, color = NA, adjust = 1.1) +
  geom_density(aes(color = threshold), fill = NA, linewidth = 1.15, adjust = 1.1) +
  
  # True values as dashed lines
  geom_vline(data = summ_cat, aes(xintercept = true_beta, color = threshold),
             linetype = "dashed", linewidth = 0.8) +
  
  scale_fill_manual(values = cols_cat) +
  scale_color_manual(values = cols_cat) +
  
  scale_x_continuous(expand = expansion(mult = c(0.02, 0.02))) +
  scale_y_continuous(expand = expansion(mult = c(0.02, 0.02))) +
  
  annotate(
    "label",
    x = 0.8, 
    y = ymax,
    label = ann_text,
    hjust = 0, vjust = 1,
    size = 3.1,
    label.size = 0.25,
    fill = "white", alpha = 0.92
  ) +
  
  labs(
    title = "Categorical Threshold Validation",
    subtitle = "Dashed lines show true simulated values",
    x = "β (log-odds; incremental effect)",
    y = "Density",
    color = "Threshold",
    fill = "Threshold"
  ) +
  coord_cartesian(xlim = c(NA, 1.5), clip = "off") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "bold"),
    legend.position = "bottom",
    plot.margin = margin(t = 10, r = 40, b = 10, l = 10)
  )

plot_categorical_validation



```


# With null simulated data

```{r}
sim_data_null_condensed <- sim_data_null_condensed |>
  mutate(
    dose_2 = as.numeric(num_doses >= 2),
    dose_3 = as.numeric(num_doses >= 3),
    dose_4 = as.numeric(num_doses >= 4),
    dose_5plus = as.numeric(num_doses >= 5)
  )

```


```{r}
fit_null_categorical_skeptical <- brm(
  response ~ dose_2 + dose_3 + dose_4 + dose_5plus + age_centered + 
             immunosuppressed + location_condensed + stage_condensed + 
             agent + ecog_condensed,
  data = sim_data_null_condensed,
  family = bernoulli(link = "logit"),
  prior = priors_categorical_skeptical,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 2000
)
```
```{r}
summary(fit_null_categorical_skeptical)
```



```{r}
fit_null_categorical_informative <- brm(
  response ~ dose_2 + dose_3 + dose_4 + dose_5plus + age_centered + 
             immunosuppressed + location_condensed + stage_condensed + 
             agent + ecog_condensed,
  data = sim_data_null_condensed,
  family = bernoulli(link = "logit"),
  prior = priors_categorical_informative,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  seed = 2000
)
```
```{r}
summary(fit_null_categorical_informative)
```



# Summary: Model Validation and Comparison

## Overview

We developed and validated three Bayesian logistic regression model specifications to assess the relationship between immunotherapy dose count and treatment response, using simulation-based calibration to ensure models can recover true effects.

## Models Evaluated

### Model 1: Linear Dose Effect

Response ~ dose_minus_1 + confounders

- Assumes constant effect per dose
- β_dose represents change in log-odds per additional dose
- Simple interpretation but may miss non-linear patterns

### Model 2: Log(Dose) - Diminishing Returns

Response ~ log(dose) + confounders


- Captures sigmoid pattern: large early gains, then plateau
- β_log_dose represents effect of doubling dose
- Best for diminishing returns hypothesis

### Model 3: Cumulative Dose Categories

- Non-parametric approach
- β₂ = benefit of 2nd dose vs 1
- β₃ = additional benefit of 3rd dose (beyond 2)
- β₄ = additional benefit of 4th dose (beyond 3)
- β₅₊ = additional benefit of 5+ doses (beyond 4)
- No functional form assumptions

## Validation Results

| Dataset | True Effect | Model 1 (Linear) | Model 2 (Log) | Model 3 (Cumulative) |
|---------|-------------|------------------|---------------|----------------------|
| Null (β=0) | 0 | -0.001 ✓ | 0.19 | All ≈ 0 ✓ |
| Linear (β=0.2) | 0.2 | 0.10 | - | - |
| Sigmoid (β=0.8) | 0.8 | 0.15 | 0.75 ✓ | - |
| Cumulative | 0.5,0.3,0.2,0.1 | - | - | 0.36,0.13,0.21,0.22 |

## Key Findings

1. **All models correctly identified null effects** (no false positives)
2. **Log model best captured sigmoid patterns** (BF₁₀ = 1999 for true effect)
3. **Prior sensitivity matters**


# Graph for Supplemental Data
```{r}
#| label: fig-validation-combined
#| fig-width: 11
#| fig-height: 9
#| fig-cap: >
#|   **Model Validation via Simulation-Based Calibration.**
#|   Posterior distributions from Bayesian models fitted to simulated data with 
#|   known effect sizes. **(A)** Null scenario: true β = 0; model correctly 
#|   centers near zero with wide credible interval. **(B)** Moderate linear effect: 
#|   true β = 0.2; model recovers effect with high posterior probability of 
#|   meaningful benefit. **(C)** Strong sigmoid effect: true β_log = 0.8; 
#|   log-dose model captures diminishing returns pattern. **(D)** Categorical 
#|   thresholds: true values β₂=0.5, β₃=0.3, β₄=0.2, β₅₊=0.1 (dashed lines); 
#|   model recovers heterogeneous effects without parametric assumptions. 
#|   All models demonstrate adequate sensitivity to detect clinically meaningful 
#|   effects when present while appropriately quantifying uncertainty.

library(patchwork)

combined_validation <- 
  (plot_null_linear_skeptical | plot_moderate_linear_informative) / 
  (plot_sigmoid_log_informative | plot_categorical_validation) +
  plot_annotation(
    tag_levels = 'A',
    theme = theme(plot.tag = element_text(face = 'bold', size = 14))
  )

combined_validation

save_files(
  save_object = combined_validation,
  filename = "Model Validation Four Panel Figure",
  subD = "files/Simulated Data/Validation Figures"
)

save_files(
  save_object = combined_validation,
  filename = "Model Validation Four Panel Figure",
  subD = "files/Simulated Data/Validation Figures",
  extension = ".png",
  width = 11,
  height = 9,
  dpi = 300,
  units = "in"
)


```

## Save Key Model Objects
```{r}
# Save key validation model objects
save(
  fit_null,                    # Null scenario (linear)
  fit_null_informative,
  fit_null_skeptical,
  fit_effect_informative,      # Moderate linear (β=0.2)
  fit_sigmoid_log,             # Strong sigmoid (β_log=0.8)
  file = here::here("files/Simulated Data/validation_models.RData")
)

```
